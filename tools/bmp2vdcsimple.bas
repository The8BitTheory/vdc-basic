#RetroDevStudio.MetaData.BASIC:7169,BASIC V7.0 VDC,uppercase,10,10
# THIS CREATES A VDC EGA-CHUNKY FILE FROM A 4-BIT BITMAP (16 COLOR)

# 4.64 MINUTES WRITING TO VRAM
# 4.16 MINUTES POKING AND THEN WRITING TO VRAM

10 GRAPHIC 0
# DEFINE FUNCTIONS
20 GOSUB 740
30 BS=FN W(45)
40 BE=FN W(4624)
# DB=DATA BEGIN
# DE=DATA END
50 DB=BE+1:DE=DB+8000

60 PRINT "BASIC FROM "BS" TO "BE"."
70 PRINT "LEAVES "FRE(0)" BYTES FREE."
80 DD=PEEK(186)

90 PRINT "INSERT DATADISK":GETKEY I$

100 BLOAD "VDCBASIC2F.1300",B0,U(DD):SYS DEC("1300")

110 AP=16000

# 2 SCANLINES PER CHAR, 160 SCANLINES (EACH VAL +1)
120 RGW 0,127:RGW 4,155:RGW 6,100:RGW 7,140:RGW 9,1
130 RGO 25,128:REM BITMAP MODE ON
140 RGO 28,2î¸ž4:REM 64K VRAM
150 RGW 36,0
155 RGW DEC("1A"),DEC("FF")

160 VMF 0,15,AP:REM SETUP PIXELS
170 VMF AP,0,8000: REM CLEAR ATTRIBUTE RAM
180 ATTR AP:BANK 0

182 PF$="3A.BMP":GOSUB202
#182 PF$="RED00A.BMP":GOSUB202
#182 PF$="TITLE.BMP":GOSUB202

#182 FOR FI=1TO19
#184  PF$=MID$(STR$(FI),2)+".BMP"
#186  GOSUB 202
#188 NEXT

#184 PF$="4.BMP":GOSUB202

#182 FOR FI=1TO3
#184  PF$="TREE"+MID$(STR$(FI),2)+".BMP"
#186  GOSUB 202
#188 NEXT

#190 FOR FI=1 TO 4
#192  PF$="WATER"+MID$(STR$(FI),2)+".BMP"
#194  GOSUB 202
#195 NEXT

#196 FOR FI=1 TO 4
#197  PF$="WATERB"+MID$(STR$(FI),2)+".BMP"
#198  GOSUB 202
#199 NEXT

200 BANK15:END




202 PRINT "LOADING "PF$" ... ";
204 OPEN1,DD,0,PF$
206 GET#1,B1$,B2$
208 CLOSE1
210 POKE DB,ASC(B1$):POKEDB+1,ASC(B2$)

212 BLOAD (PF$),B0,P(DB+2),U(DD)
214 PRINT "DONE"
216 H1=PEEK(DB):H2=PEEK(DB+1)
218 IF (CHR$(H1)+CHR$(H2)) = "BM" THEN GOSUB 300

270 SLOW


290 RETURN


##################
# BITMAP ROUTINE #
##################

# HEADER
300 PRINT "BITMAP"
310 IS=FN W(DB+2)

320 PRINT "BFSIZE"IS
330 OS=FN W4(DB+10)
340 PRINT "BFOFFBITS"OS

# INFORMATIONBLOCK
#1030 PRINT "BISIZE"FN W4(DB+14)
350 BW=FN W4(DB+18)
360 PRINT "BIWIDTH"BW
370 BH=FN W4(DB+22)
380 PRINT "BIHEIGHT"BH
390 BC=FN W(DB+28)
400 PRINT "BIBITCOUNT"BC
410 IF BC<=8 THEN PRINT " INDICED COLORS"
420 IF BC >8 THEN PRINT " COLOR DEPTH "BC" NOT SUPPORTED. THE END.":END
430 PRINT "BICOMPRESSION"FN W4(DB+30)
440 P1=FN W4(DB+34):PRINT "BISIZEIMAGE"P1
#1090 PRINT "BIXPELSPERMETER"FN W4(DB+38)
#1100 PRINT "BIYPELSPERMETER"FN W4(DB+42)
450 CU=FN W4(DB+46)
460 PRINT "BICLRUSED"CU
470 PRINT "BICLRIMPORTANT"FN W4(DB+50)

# PALETTE
480 IF CU<>0 THEN PRINT " PALETTE WITH "CU" ENTRIES":GOTO 510
490 IF BC<=8 THEN PRINT " PALETTE WITH "BC" ENTRIES":GOTO 510: ELSE PRINT " NO PALETTE"


# IMAGEDATA
510 FAST:BANK0
512 ID=DB+OS
514 VP=AP+P1-BW
#514 VP=23999-P2
516 BW=BW/2-1
517 P2=P1/BH

520 S=TI:FOR Y=BH TO 0 STEP -1
530  FOR X=0 TO BW

#540   IF BC=4 THEN C1$=MID$(HEX$(PEEK(ID)),3,1):C2$=RIGHT$(HEX$(PEEK(ID)),1):ID=ID+1:GOTO 560
540   C1$=MID$(HEX$(PEEK(ID)),3,1):C2$=RIGHT$(HEX$(PEEK(ID)),1):ID=ID+1:GOTO 560

#550   IF BC=8 THEN C1$=RIGHT$(HEX$(PEEK(ID)),1):ID=ID+1:C2$=RIGHT$(HEX$(PEEK(ID)),1):ID=ID+1

#     WRITE TWO PIXELS TO VRAM
560   VMW VP,DEC(C1$+C2$):VP=VP+1
570  NEXT
572  IF P2-BW>0 THEN ID=ID+(P2-BW)-1

580  IF Y>0 THEN VP=VP-BW-BW-2

585  SLOW:PRINT "LINE "Y:FAST

590 NEXT:S=TI-S:SLOW:PRINT "TOOK "S" JIFFIES"

#   COPY FROM VRAM TO RAM
600 FL=(BW+1)*BH

605 PRINT "VDC-FILE LENGTH:"FL
606 PRINT "COPYING "FL" BYTES TO RAM AT "(DB+2)
607 PRINT "KEY TO CONTINUE":GETKEY I$

610 VTR VP,DB+2,FL

#   COPY FROM INVISIBLE TO VISIBLE VRAM (FOR VISUAL VALIDATION)
#620 VMC VP,AP,BW+1,BH,80,BW+1

630 POKE DB,BW:POKE DB+1,BH

640 WF$="@"+LEFT$(PF$,LEN(PF$)-4)+".VDC"
650 BSAVE (WF$),B0,U(DD),P(DB) TO P(DB+FL+2)

660 RETURN





#620 FAST:BANK0:ID=DB+OS:VP=DB+IS+BH*80:BW=BW/2-1
#630 S=TI:FOR Y=BH-1 TO 0 STEP -1
#640  FOR X=0 TO BW
#650   IF BC=4 THEN C1$=MID$(HEX$(PEEK(ID)),3,1):C2$=RIGHT$(HEX$(PEEK(ID)),1):ID=ID+1:GOTO 670
#660   IF BC=8 THEN C1$=RIGHT$(HEX$(PEEK(ID)),1):ID=ID+1:C2$=RIGHT$(HEX$(PEEK(ID)),1):ID=ID+1
#670   POKE VP,DEC(C1$+C2$):VP=VP+1
#680  NEXT
#690  VP=VP-160

#700 NEXT
#710 RTV DB+IS,AP,(BW+1)*BH:S=TI-S:PRINT S

#720 RETURN




730 RETURN

740 DEF FN W(ZZ)=PEEK(ZZ)+PEEK(ZZ+1)*256
750 DEF FN W4(ZZ)=PEEK(ZZ)+PEEK(ZZ+1)*256+PEEK(ZZ+2)*65536+PEEK(ZZ+3)*16777216
760 DEF FN V(ZZ)=DEC(RIGHT$(HEX$(ZZ),1))
770 DEF FN HN(ZZ)=DEC(MID$(HEX$(ZZ),3,1))
780 DEF FN LN(ZZ)=DEC(RIGHT$(HEX$(ZZ),1))

790 RETURN